const day1Data = {
  data1: [
    {time: '2022-05-01', value: 1850.00},
    {time: '2022-05-06', value: 1750.00},
    {time: '2022-05-30', value: 1950.00}
  ],
  data2: [
    {time: '2022-05-01', value: 1850.00}
  ],
};

const day5Data = {
  data1: [
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-03', value: 1850.00},
    {time: '2022-05-05', value: 1700.00}
  ],
  data2: [
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-03', value: 1850.00},
    {time: '2022-05-05', value: 1700.00},
    {time: '2022-05-15', value: 1700.00},
    {time: '2022-05-25', value: 1700.00}
  ],
};

const month1Data = {
  data1: [
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-03', value: 1850.00},
    {time: '2022-05-05', value: 1700.00}
  ],
  data2: [
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-03', value: 1850.00},
    {time: '2022-05-05', value: 1700.00},
    {time: '2022-05-15', value: 1700.00},
    {time: '2022-05-25', value: 1700.00}
  ],
};

const month3Data = {
  data1: [
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-03', value: 1850.00},
    {time: '2022-05-05', value: 1700.00}
  ],
  data2: [
    {time: '2022-01-05', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-03', value: 1850.00},
    {time: '2022-05-05', value: 1700.00},
    {time: '2022-05-15', value: 1700.00},
    {time: '2022-05-25', value: 1700.00}
  ],
};

const month6Data = {
  data1: [
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00}
  ],
  data2: [
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-05', value: 1700.00},
    {time: '2022-05-15', value: 1700.00},
    {time: '2022-05-25', value: 1700.00}
  ],
};

const year1Data = {
  data1: [
    {time: '2021-06-22', value: 1850.00},
    {time: '2021-07-01', value: 1900.00},
    {time: '2021-07-30', value: 1800.00},
    {time: '2021-09-31', value: 1800.00},
    {time: '2021-10-02', value: 1950.00},
    {time: '2021-10-15', value: 1950.00},
    {time: '2021-10-30', value: 1900.00},
    {time: '2021-11-01', value: 1950.00},
    {time: '2021-11-10', value: 1900.00},
    {time: '2021-11-31', value: 1900.00},
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00}
  ],
  data2: [
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-05', value: 1700.00},
    {time: '2022-05-15', value: 1700.00},
    {time: '2022-05-25', value: 1700.00}
  ],
};

const year5Data = {
  data1: [
    {time: '2021-06-22', value: 1850.00},
    {time: '2021-07-01', value: 1900.00},
    {time: '2021-07-30', value: 1800.00},
    {time: '2021-09-31', value: 1800.00},
    {time: '2021-10-02', value: 1950.00},
    {time: '2021-10-15', value: 1950.00},
    {time: '2021-10-30', value: 1900.00},
    {time: '2021-11-01', value: 1950.00},
    {time: '2021-11-10', value: 1900.00},
    {time: '2021-11-31', value: 1900.00},
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00}
  ],
  data2: [
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-05', value: 1700.00},
    {time: '2022-05-15', value: 1700.00},
    {time: '2022-05-25', value: 1700.00}
  ],
};

const allData = {
  data1: [
    {time: '2020-06-22', value: 1850.00},
    {time: '2020-07-01', value: 1900.00},
    {time: '2020-07-30', value: 1800.00},
    {time: '2020-09-31', value: 1800.00},
    {time: '2020-10-02', value: 1950.00},
    {time: '2020-10-15', value: 1950.00},
    {time: '2020-10-30', value: 1900.00},
    {time: '2020-11-01', value: 1950.00},
    {time: '2020-11-10', value: 1900.00},
    {time: '2020-11-31', value: 1900.00},
    {time: '2021-01-01', value: 2000.00},
    {time: '2021-01-15', value: 2000.00},
    {time: '2021-01-31', value: 1900.00},
    {time: '2021-03-05', value: 1900.00},
    {time: '2021-05-01', value: 1750.00},
    {time: '2021-06-22', value: 1850.00},
    {time: '2021-07-01', value: 1900.00},
    {time: '2021-07-30', value: 1800.00},
    {time: '2021-09-31', value: 1800.00},
    {time: '2021-10-02', value: 1950.00},
    {time: '2021-10-15', value: 1950.00},
    {time: '2021-10-30', value: 1900.00},
    {time: '2021-11-01', value: 1950.00},
    {time: '2021-11-10', value: 1900.00},
    {time: '2021-11-31', value: 1900.00},
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00}
  ],
  data2: [
    {time: '2022-01-01', value: 2000.00},
    {time: '2022-01-15', value: 2000.00},
    {time: '2022-01-31', value: 1900.00},
    {time: '2022-03-05', value: 1900.00},
    {time: '2022-05-01', value: 1750.00},
    {time: '2022-05-05', value: 1700.00},
    {time: '2022-05-15', value: 1700.00},
    {time: '2022-05-25', value: 1700.00}
  ],
};

const intervals = ['1 день', '5 дней', '1 мес', '3 мес', '6 мес', '1 год', '5 лет', 'Все'];
let areaSeries = null;
let activeIndex = 0;
let activeSeriesesData;

const syncToInterval = (interval, seriesesData, chart, chartBlock) => {
  if (areaSeries) {
    chart.removeSeries(areaSeries);
    areaSeries = null;
    chartBlock.classList.remove('is-active');
  }

  areaSeries = chart.addAreaSeries({
    topColor: 'rgba(51, 89, 153, 1)',
    bottomColor: 'rgba(51, 89, 153, 0)',
    lineColor: '#2B7AFF',
    lineWidth: 1,
    crosshairMarkerVisible: false,
  });

  areaSeries.setData(seriesesData.get(interval));
  chart.timeScale().fitContent();

  setTimeout(() => {
    chartBlock.classList.add('is-active');
  }, 100);
};

const setState = (btn, intervalsData, seriesesData, chart, chartBlock) => {
  const legend = document.querySelector('[data-quotations-legend]');
  const legendTitle = legend.querySelector('.quotations__legend-title');
  const legendText = legend.querySelector('.quotations__legend-text');

  legendTitle.innerText = btn.querySelector('.custom-toggle__label').textContent;
  legendText.innerText = intervalsData[0][intervalsData[0].length - 1].value.toFixed(2) + ' ' + legendTitle.textContent.split(' / ')[1];

  syncToInterval(intervals[activeIndex], seriesesData, chart, chartBlock);
};

const quotationsToggle = (chart, chartBlock) => {
  const quotationsBtns = document.querySelectorAll('[data-quotations-btn]');
  const switcherBtns = document.querySelectorAll('[data-switcher-btn]');

  quotationsBtns.forEach((btn) => {
    const input = btn.querySelector('input');
    const base = btn.dataset.base;

    const intervalsData = [day1Data[base], day5Data[base], month1Data[base], month3Data[base], month6Data[base], year1Data[base], year5Data[base], allData[base]];

    const seriesesData = new Map([
      [intervals[0], intervalsData[0]],
      [intervals[1], intervalsData[1]],
      [intervals[2], intervalsData[2]],
      [intervals[3], intervalsData[3]],
      [intervals[4], intervalsData[4]],
      [intervals[5], intervalsData[5]],
      [intervals[6], intervalsData[6]],
      [intervals[7], intervalsData[7]]
    ]);

    getActiveIndex(switcherBtns);

    setTimeout(() => {
      if (input.checked) {
        activeSeriesesData = seriesesData;
        setState(btn, intervalsData, seriesesData, chart, chartBlock);
      }
    }, 0);


    input.addEventListener('change', () => {
      getActiveIndex(switcherBtns);

      setTimeout(() => {
        if (input.checked) {
          activeSeriesesData = seriesesData;
          setState(btn, intervalsData, seriesesData, chart, chartBlock);
        }
      }, 0);
    });
  });

  switcherBtns.forEach((btn) => {
    const input = btn.querySelector('input');
    const index = btn.dataset.switcherIndex;

    btn.addEventListener('click', () => {
      if (input.checked) {
        activeIndex = index;
        syncToInterval(intervals[activeIndex], activeSeriesesData, chart, chartBlock);
      }
    });
  });
};

const getActiveIndex = (switcherBtns) => {
  switcherBtns.forEach((btn) => {
    const input = btn.querySelector('input');
    const index = btn.dataset.switcherIndex;

    if (input.checked) {
      activeIndex = index;
    }
  });
};

const initQuotations = () => {
  const chartBlock = document.querySelector('[data-chart]');
  const toolTip = document.querySelector('[data-chart] .quotations__tooltip');
  const toolTipPrice = document.querySelector('[data-chart] .quotations__tooltip-price');
  const toolTipDate = document.querySelector('[data-chart] .quotations__tooltip-date');
  const toolTipMargin = -50;

  if (!chartBlock) {
    return;
  }

  const chart = LightweightCharts.createChart(chartBlock, {
    rightPriceScale: {
      borderVisible: false,
      labelVisible: false,
    },
    timeScale: {
      borderVisible: false,
    },
    layout: {
      fontFamily: 'Grandis Extended',
      backgroundColor: '#1D295C',
      textColor: 'rgba(255, 255, 255, 1)',
    },
    grid: {
      vertLines: {
        visible: false,
      },
      horzLines: {
        visible: false,
      },
    },
    crosshair: {
      vertLine: {
        labelVisible: false,
        style: 0,
        width: 1,
        color: 'rgba(255, 255, 255, 0.15)',
      },
      horzLine: {
        visible: false,
        labelVisible: false,
      },
    },
    handleScale: {
      mouseWheel: false,
    },
  });

  chart.timeScale().fitContent();

  quotationsToggle(chart, chartBlock);

  const businessDayToString = (businessDay) => {
    return businessDay.day + '-' + businessDay.month + '-' + businessDay.year;
  };

  // update tooltip
  chart.subscribeCrosshairMove((param) => {
    if (param.point === 'undefined' || !param.time || param.point.x < 0 || param.point.x > chartBlock.clientWidth || param.point.y < 0 || param.point.y > chartBlock.clientHeight) {
      toolTip.style.display = 'none';
    } else {
      const dateStr = businessDayToString(param.time);
      toolTip.style.display = 'block';
      const price = param.seriesPrices.get(areaSeries);
      toolTipPrice.innerHTML = price.toFixed(2);
      toolTipDate.innerHTML = dateStr;
      const coordinate = areaSeries.priceToCoordinate(price);
      let shiftedCoordinate = param.point.x - 50;
      if (coordinate === null) {
        return;
      }
      shiftedCoordinate = Math.max(0, Math.min(chartBlock.clientWidth - toolTip.scrollWidth, shiftedCoordinate));
      const coordinateY = coordinate - toolTip.scrollHeight - toolTipMargin > 0 ? coordinate - toolTip.scrollHeight - toolTipMargin : Math.max(0, Math.min(chartBlock.clientHeight - toolTip.scrollHeight - toolTipMargin, coordinate + toolTipMargin));
      toolTip.style.left = shiftedCoordinate + 'px';
      toolTip.style.top = coordinateY + 'px';
    }
  });
};

export {initQuotations};
